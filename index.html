<html>
    <head>
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script>

    </head>
    <body>
            <div stlye="container">
                  <h1>Knockout Tetris</h1>
            </div>
            
            <div style="float:left;width:20%;background-color: lightgrey;" id="debug"><strong>Debug</strong></div> 
            <div style="float:left;width:70%;background-color: lightskyblue;" id="div-game">The game board
                <table>
                    <thead>                        
                    </thead>
                    <tbody data-bind="foreach: Rows">
                        <tr>                            
                            <td data-bind="foreach: Cells"><span width="20px" data-bind="style: {'background-color': Colour}">&nbsp;&nbsp;&nbsp;</span></td>                        
                        </tr>    
                    </tbody>
                </table>
            </div>
            <timer ></timer>
    </body>
</html>

<script>

var Shapes = {

    Square: {
        Colour: "blue",
        Orientations: [
                { Pixels : [{Xoffset:0, Yoffset:0},
                          {Xoffset:1, Yoffset:0},
                          {Xoffset:0, Yoffset:1},
                          {Xoffset:1, Yoffset:1}]
                }
            ]},

    Line:  {
        Colour: "Blue",
        Orientations:[
              { Pixels:  [   {Xoffset:1, Yoffset:1},
                    {Xoffset:1, Yoffset:2},
                    {Xoffset:1, Yoffset:3},
                    {Xoffset:1, Yoffset:4},
                ]},
                {Pixels : [   {Xoffset:0, Yoffset:1},
                    {Xoffset:1, Yoffset:1},
                    {Xoffset:2, Yoffset:1},
                    {Xoffset:3, Yoffset:1},
                ]}
            ]},
    LeftL:{},

    RightL:{},

    LeftZ: {
        Colour: "Blue",
        Orientations: [
                {Pixels : [{Xoffset:0, Yoffset:0},
                          {Xoffset:1, Yoffset:0},
                          {Xoffset:1, Yoffset:1},
                          {Xoffset:2, Yoffset:1},
                ]},
                {Pixels : [{Xoffset:1, Yoffset:0},
                    {Xoffset:0, Yoffset:1},
                    {Xoffset:1, Yoffset:1},
                    {Xoffset:0, Yoffset:2},
                ]}
            ]},
    RightZ: {}
};

var Translate = {
    Down: function(){},
    Left: function(){},
    Right: function(){},
    Clockwise: function(){}
};

var Event = {

    OnTick: function () {
        ActiveBlock.MoveDown();
    },

    OnKeyDown: function (key){
        switch(key){
            case "ArrowLeft": ActiveBlock.MoveLeft();
            break;
            case "ArrowRight": ActiveBlock.MoveRight();
            break;
            case "ArrowDown": ActiveBlock.MoveDrop();
            break;
            case "ArrowUp": ActiveBlock.Rotate();
        }
    }
}

var NextBlock = {

};

var BACKGROUND_COLOUR="black";

var Board = function() {

    var ColumnCount = 10;
    var RowsCount = 10;
   
    var Rows = ko.observableArray();
    
    var cell = function(){
        var Colour = ko.observable(BACKGROUND_COLOUR);
        var Occupied = ko.observable(false);

        var SetColour = function(colour){
            Colour(colour);
        }

        var SetOccupied = function(yes){
            Occupied(yes);
        }

        return {
            Colour: Colour,Occupied:Occupied,SetColour:SetColour,SetOccupied:SetOccupied
        }
    };

    var Init =  function () {
        
        for (var row=0;row<RowsCount;row++){      
            var cells = ko.observableArray([]);
            
            for (var col=0; col<ColumnCount;col++){
                cells.push(new cell());
            }      
            
            Rows.push({Cells: cells});
        }
    }();

    var CheckForCollision = function(shape, x, y, rotation){
       
        var collision = false;

        shape.Orientations[rotation].Pixels.forEach(function(cell){
            var row = y + cell.Yoffset ;
            var col = x + cell.Xoffset

            if (row < 0 || row > ColumnCount-1 || col >= RowsCount )
                collision = true;
            else if (Board.Rows()[row].Cells()[col].Occupied === true)
                collision = true;
        });

        return collision;
    };

    var BlockLanded = function() {
        return false;
    };

    return {
        Rows: Rows,
        CheckForCollision: CheckForCollision,
        BlockLanded: BlockLanded
    }

}();



var Game = function(){};

var ActiveBlock = function() {
    var Shape = Shapes.Square;  //for example
    var Xpos = 0;
    var Ypos = 0;
    var Rotation = 0;

    MoveDown = function() {
        if (Board.CheckForCollision(Shape, Xpos, Ypos+1,Rotation)) //this, Translate (x, y, rot)
            BlockLanded();
        else{
            Clear();
            Ypos++;
            Draw();
        }
        Debug("down");
    };

    MoveRight = function() {
        if (!Board.CheckForCollision(Shape, Xpos+1, Ypos,Rotation))
        {
            Clear();
            Xpos++;
            Draw();
        }   
        Debug("right");
    };

    MoveLeft = function(){
        if (!Board.CheckForCollision(Shape, Xpos-1, Ypos,Rotation)){
            Clear();
            Xpos--;
            Draw();
        }
        Debug("left");
    };

    Drop = function(){
        while (!Board.CheckForCollision())
        Debug("drop");
    };

    Rotate =  function(){
        if (!Board.CheckForCollision(Shape, Xpos, Ypos+1,Rotation+1 % Shape.length)){
            Clear();
            Rotation = Rotation++ % Shape.length;
            Draw();
        }
    };

    Clear =  function(){
        Shape.Orientations[Rotation].Pixels.forEach(function(cell){
            var row = Ypos + cell.Yoffset ;
            var col = Xpos + cell.Xoffset

            Board.Rows()[row].Cells()[col].SetColour(BACKGROUND_COLOUR)
            //Board.Rows()[row].Cells()[col].Occupied = false;
        });
    };

    Draw = function(landed){
        Shape.Orientations[Rotation].Pixels.forEach(function(cell){
            var row = Ypos + cell.Yoffset ;
            var col = Xpos + cell.Xoffset

            Board.Rows()[row].Cells()[col].SetColour(Shape.Colour); 
            if (landed)
                Board.Rows()[row].Cells()[col].SetOccupied(true);
        });
    };

    BlockLanded = function(){
        Draw(true)
        //alertalert("Landed!");
        // TODO - pick random shape
        // TODO - check for lines
        // TODO - remove complete lines
        // TODO - Map to UI with back bone
        
    };

    return {
        MoveDown: MoveDown,
        MoveRight: MoveRight,
        MoveLeft: MoveLeft,
        Drop: Drop,
        Rotate: Rotate
    }
}();

function Debug(string){

    var $debug = $("#debug");

    $debug.append("<div>"+ string +"</div>");

    if ($debug .find("div").length > 20 )
        $debug.find("div:first").remove();
}

$(function (){
    Debug("ready");
    setInterval(Event.OnTick,500);
    $(document).on("keydown", function(key) {
        Event.OnKeyDown(key.code);
    });    
});

var testRow = function(colour){
    
    var Colour=ko.observable();

    var setColour=function(c){
        Colour(c);
    }

    setColour(colour);
    
    //this.Colour=colour;

    return {Colour:Colour,
    setColour:setColour}
};

var test = function() {

    var Rows = ko.observableArray();
    for (var row=0;row<10;row++){      
        Rows.push(new testRow(row));
    }

    return {
        Rows: Rows
    }

}();



ko.applyBindings(Board);

</script>